import{a as M}from"./chunk-Q2IYTWOU.js";import{a as je,b as Be}from"./chunk-WLHEW2W3.js";import{a as S}from"./chunk-D772OIOF.js";import{a as z}from"./chunk-ZUQ7TKCG.js";import{a as J}from"./chunk-T56IFQX4.js";import{J as De,K as de,L as Y,M as N,N as Re,c as Pe,e as b,g as X,h as I,m as _,n as w,o as H,r as Oe}from"./chunk-SZOBYU5N.js";import{$ as p,B as ke,C as j,Da as A,E as Ce,Ea as V,Eb as $,Fa as L,Fb as W,Ga as ge,H as f,Ha as l,Hb as pe,I as B,Ia as Fe,Ja as U,Ka as Ee,N as F,O as E,Oa as xe,P as ye,Ra as Ie,Va as _e,Wa as we,_ as c,d as R,ha as be,ib as q,ja as h,jb as y,la as s,lb as Ne,m as he,ma as le,na as G,pa as n,pb as Me,qa as a,qb as Q,ra as m,ua as Se,ub as Te,va as x,ya as k,za as v}from"./chunk-BFXX2XRG.js";function He(i,t){if(i&1){let e=x();n(0,"li",4)(1,"div",5)(2,"button",6),k("click",function(){let o=F(e).index,d=v();return E(d.onClick(o))}),l(3),a()()()}if(i&2){let e=t.$implicit,r=t.index,o=v();c(2),G("active",o.selectedIndex===r),s("disabled",!0),c(),U(" ",e.label," ")}}function Ye(i,t){if(i&1&&(n(0,"div"),Se(1,7),a()),i&2){let e=v();c(),s("ngTemplateOutlet",e.selected.content)}}var Z=class i extends de{linearModeSelected=!0;ngOnInit(){this.linear=this.linearModeSelected}onClick(t){this.selectedIndex=t}static \u0275fac=(()=>{let t;return function(r){return(t||(t=ye(i)))(r||i)}})();static \u0275cmp=f({type:i,selectors:[["app-stepper"]],inputs:{linearModeSelected:"linearModeSelected"},features:[xe([{provide:de,useExisting:i}]),be],decls:4,vars:2,consts:[[1,"container"],[1,"nav","nav-pills","nav-justified"],["class","nav-item",4,"ngFor","ngForOf"],[4,"ngIf"],[1,"nav-item"],[1,"d-grid"],[1,"nav-link","py-3","text-uppercase","fw-bold",3,"click","disabled"],[3,"ngTemplateOutlet"]],template:function(e,r){e&1&&(n(0,"div",0)(1,"ul",1),h(2,He,4,4,"li",2),a(),h(3,Ye,2,1,"div",3),a()),e&2&&(c(2),s("ngForOf",r.steps),c(),s("ngIf",r.selected))},dependencies:[q,y,Ne],styles:["button.nav-link[_ngcontent-%COMP%]{background:#e9ecef;border-radius:0;border:none;color:#333}button.nav-link[_ngcontent-%COMP%]:disabled:not(.active){color:#333;background:#e9ecef}"]})};function et(i,t){if(i&1){let e=x();n(0,"div",6)(1,"div",7)(2,"h4"),l(3,"Shipping address"),a(),n(4,"button",8),k("click",function(){F(e);let o=v();return E(o.saveUserAddress())}),l(5," Save as default address "),a()(),n(6,"div",9)(7,"div",10),m(8,"app-text-input",11),a(),n(9,"div",10),m(10,"app-text-input",12),a(),n(11,"div",10),m(12,"app-text-input",13),a(),n(13,"div",10),m(14,"app-text-input",14),a(),n(15,"div",10),m(16,"app-text-input",15),a()()()}if(i&2){let e,r=v();s("formGroup",r.checkoutForm),c(4),s("disabled",!((e=r.checkoutForm.get("addressForm"))!=null&&e.valid)||!((e=r.checkoutForm.get("addressForm"))!=null&&e.dirty)),c(4),s("label","First name"),c(2),s("label","Last name"),c(2),s("label","Street"),c(2),s("label","City"),c(2),s("label","Zip code")}}var ee=class i{constructor(t,e){this.accountService=t;this.toastr=e}checkoutForm;saveUserAddress(){this.accountService.updateUserAddress(this.checkoutForm?.get("addressForm")?.value).subscribe({next:()=>{this.toastr.success("Address saved"),this.checkoutForm?.get("addressForm")?.reset(this.checkoutForm?.get("addressForm")?.value)}})}static \u0275fac=function(e){return new(e||i)(p(J),p(M))};static \u0275cmp=f({type:i,selectors:[["app-checkout-address"]],inputs:{checkoutForm:"checkoutForm"},decls:8,vars:2,consts:[["class","mt-4",3,"formGroup",4,"ngIf"],[1,"d-flex","justify-content-between","flex-row","mb-5"],["routerLink","/basket",1,"btn","btn-outline-primary"],[1,"fa","fa-angle-left"],["cdkStepperNext","",1,"btn","btn-primary",3,"disabled"],[1,"fa","fa-angle-right"],[1,"mt-4",3,"formGroup"],[1,"d-flex","justify-content-between","align-items-center"],[1,"btn","btn-outline-success","mb-3",3,"click","disabled"],["formGroupName","addressForm",1,"row"],[1,"form-group","col-6"],["formControlName","firstName",3,"label"],["formControlName","lastName",3,"label"],["formControlName","street",3,"label"],["formControlName","city",3,"label"],["formControlName","zipcode",3,"label"]],template:function(e,r){if(e&1&&(h(0,et,17,7,"div",0),n(1,"div",1)(2,"button",2),m(3,"i",3),l(4," Back to basket "),a(),n(5,"button",4),l(6," Go to Delivery "),m(7,"i",5),a()()),e&2){let o;s("ngIf",r.checkoutForm),c(5),s("disabled",r.checkoutForm==null||(o=r.checkoutForm.get("addressForm"))==null?null:o.invalid)}},dependencies:[y,W,X,I,_,H,w,z,Y]})};var P=class i{constructor(t){this.http=t}baseUrl=Pe.apiUrl;createOrder(t){return this.http.post(this.baseUrl+"orders",t)}getDeliveryMethods(){return this.http.get(this.baseUrl+"orders/deliveryMethods").pipe(he(t=>t.sort((e,r)=>r.price-e.price)))}static \u0275fac=function(e){return new(e||i)(Ce(Te))};static \u0275prov=ke({token:i,factory:i.\u0275fac,providedIn:"root"})};function rt(i,t){if(i&1){let e=x();n(0,"div",8)(1,"div",9),k("click",function(){let o,d=F(e).$implicit,u=v();return u.setShippingPrice(d),E((o=u.checkoutForm.get("deliveryForm.deliveryMethod"))==null?null:o.setValue(d.id))}),n(2,"label",10)(3,"strong"),l(4),_e(5,"currency"),a(),m(6,"br"),n(7,"span",11),l(8),a()()()()}if(i&2){let e,r,o,d,u=t.$implicit,g=v();c(2),le("color",((e=g.checkoutForm.get("deliveryForm.deliveryMethod"))==null?null:e.value)===u.id?"white":""),G("bg-primary",((r=g.checkoutForm.get("deliveryForm.deliveryMethod"))==null?null:r.value)===u.id)("text-white",((o=g.checkoutForm.get("deliveryForm.deliveryMethod"))==null?null:o.value)===u.id),c(2),Ee("",u.shortName," - ",we(5,11,u.price),""),c(3),le("color",((d=g.checkoutForm.get("deliveryForm.deliveryMethod"))==null?null:d.value)===u.id?"white":""),c(),U(" ",u.description," ")}}var re=class i{constructor(t,e){this.checkoutService=t;this.basketService=e}checkoutForm;deliveryMethods;ngOnInit(){this.checkoutService.getDeliveryMethods().subscribe(t=>{this.deliveryMethods=t},t=>{console.log(t)})}setShippingPrice(t){this.basketService.setShippingPrice(t)}static \u0275fac=function(e){return new(e||i)(p(P),p(S))};static \u0275cmp=f({type:i,selectors:[["app-checkout-delivery"]],inputs:{checkoutForm:"checkoutForm"},decls:12,vars:3,consts:[[1,"mt-4",3,"formGroup"],["formGroupName","deliveryForm",1,"row","mt-4","mb-4"],["class","col-6",4,"ngFor","ngForOf"],[1,"d-flex","justify-content-between","flex-row","mb-5"],["cdkStepperPrevious","",1,"btn","btn-outline-primary"],[1,"fa","fa-angle-left"],["cdkStepperNext","",1,"btn","btn-primary",3,"disabled"],[1,"fa","fa-angle-right"],[1,"col-6"],[1,"form-check",3,"click"],[1,"form-check-label","d-block","p-3","border","rounded","mb-3","cursor-pointer"],[1,"description-text"]],template:function(e,r){if(e&1&&(n(0,"div",0)(1,"h4"),l(2,"Choose Your Delivery Method"),a(),n(3,"div",1),h(4,rt,9,13,"div",2),a()(),n(5,"div",3)(6,"button",4),m(7,"i",5),l(8," Back to Address "),a(),n(9,"button",6),l(10," Go to Review "),m(11,"i",7),a()()),e&2){let o;s("formGroup",r.checkoutForm),c(4),s("ngForOf",r.deliveryMethods),c(5),s("disabled",(o=r.checkoutForm.get("deliveryForm"))==null?null:o.invalid)}},dependencies:[q,I,_,w,Y,N,Me],styles:[".cursor-pointer[_ngcontent-%COMP%]{cursor:pointer}.form-check-label[_ngcontent-%COMP%]{transition:background .3s ease-in-out}.form-check-label[_ngcontent-%COMP%]:hover{background:#007bff1a}"]})};var ie=class i{constructor(t,e){this.basketService=t;this.toastr=e}appStepper;basket$;ngOnInit(){this.basket$=this.basketService.basket$}createPaymentIntent(){return this.basketService.createPaymentIntent().subscribe(t=>{this.appStepper.next()},t=>{console.log(t)})}static \u0275fac=function(e){return new(e||i)(p(S),p(M))};static \u0275cmp=f({type:i,selectors:[["app-checkout-review"]],inputs:{appStepper:"appStepper"},decls:9,vars:1,consts:[[1,"container","mt-4"],[3,"isBasket"],[1,"d-flex","justify-content-between","flex-row","mb-5"],["cdkStepperPrevious","",1,"btn","btn-outline-primary"],[1,"fa","fa-angle-left"],[1,"btn","btn-primary",3,"click"],[1,"fa","fa-angle-right"]],template:function(e,r){e&1&&(n(0,"div",0),m(1,"app-basket-summary",1),a(),n(2,"div",2)(3,"button",3),m(4,"i",4),l(5," Back to Delivery "),a(),n(6,"button",5),k("click",function(){return r.createPaymentIntent()}),l(7," Go to Payment "),m(8,"i",6),a()()),e&2&&(c(),s("isBasket",!1))},dependencies:[N,Be]})};var qe="basil",nt=function(t){return t===3?"v3":t},Qe="https://js.stripe.com",at="".concat(Qe,"/").concat(qe,"/stripe.js"),ct=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,st=/^https:\/\/js\.stripe\.com\/(v3|[a-z]+)\/stripe\.js(\?.*)?$/,Le="loadStripe.setLoadParameters was called but an existing Stripe.js script already exists in the document; existing script parameters will be used",mt=function(t){return ct.test(t)||st.test(t)},lt=function(){for(var t=document.querySelectorAll('script[src^="'.concat(Qe,'"]')),e=0;e<t.length;e++){var r=t[e];if(mt(r.src))return r}return null},Ue=function(t){var e=t&&!t.advancedFraudSignals?"?advancedFraudSignals=false":"",r=document.createElement("script");r.src="".concat(at).concat(e);var o=document.head||document.body;if(!o)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return o.appendChild(r),r},pt=function(t,e){!t||!t._registerWrapper||t._registerWrapper({name:"stripe-js",version:"7.0.0",startTime:e})},O=null,oe=null,ne=null,dt=function(t){return function(e){t(new Error("Failed to load Stripe.js",{cause:e}))}},ut=function(t,e){return function(){window.Stripe?t(window.Stripe):e(new Error("Stripe.js not available"))}},ft=function(t){return O!==null?O:(O=new Promise(function(e,r){if(typeof window>"u"||typeof document>"u"){e(null);return}if(window.Stripe&&t&&console.warn(Le),window.Stripe){e(window.Stripe);return}try{var o=lt();if(o&&t)console.warn(Le);else if(!o)o=Ue(t);else if(o&&ne!==null&&oe!==null){var d;o.removeEventListener("load",ne),o.removeEventListener("error",oe),(d=o.parentNode)===null||d===void 0||d.removeChild(o),o=Ue(t)}ne=ut(e,r),oe=dt(r),o.addEventListener("load",ne),o.addEventListener("error",oe)}catch(u){r(u);return}}),O.catch(function(e){return O=null,Promise.reject(e)}))},vt=function(t,e,r){if(t===null)return null;var o=e[0],d=o.match(/^pk_test/),u=nt(t.version),g=qe;d&&u!==g&&console.warn("Stripe.js@".concat(u," was loaded on the page, but @stripe/stripe-js@").concat("7.0.0"," expected Stripe.js@").concat(g,". This may result in unexpected behavior. For more information, see https://docs.stripe.com/sdks/stripejs-versioning"));var ve=t.apply(void 0,e);return pt(ve,r),ve},D,$e=!1,We=function(){return D||(D=ft(null).catch(function(t){return D=null,Promise.reject(t)}),D)};Promise.resolve().then(function(){return We()}).catch(function(i){$e||console.warn(i)});var Je=function(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];$e=!0;var o=Date.now();return We().then(function(d){return vt(d,e,o)})};var ht=["cardNumber"],kt=["cardExpiry"],Ct=["cardCvc"];function yt(i,t){if(i&1&&(n(0,"div",10)(1,"div",11)(2,"div",12),m(3,"app-text-input",13),a()(),n(4,"div",14)(5,"div",15)(6,"div",16),m(7,"div",17,0),n(9,"label"),l(10,"Card Number"),a(),n(11,"span",18),l(12),a()()(),n(13,"div",19)(14,"div",16),m(15,"div",17,1),n(17,"label"),l(18,"Card Expiry"),a()()(),n(19,"div",19)(20,"div",16),m(21,"div",17,2),n(23,"label"),l(24,"Card Cvc"),a()()()()()),i&2){let e=v();s("formGroup",e.checkoutForm),c(3),s("label","Name on card"),c(9),Fe(e.cardErrors)}}function bt(i,t){i&1&&m(0,"i",20)}var ae=class i{constructor(t,e,r,o){this.basketService=t;this.checkoutService=e;this.toastr=r;this.router=o}checkoutForm;cardNumberElement;cardExpiryElement;cardCvcElement;stripe=null;cardNumber;cardExpiry;cardCvc;cardNumberComplete=!1;cardExpiryComplete=!1;cardCvcComplete=!1;cardErrors;loading=!1;ngOnInit(){Je("pk_test_51R9O2TPvxgEuPMWRtNaHmeS6NVgm2RQ7MLDijSRX6omyBUDECgsGXnZY8fFfkpQUgNfdCv5A3NmWJE8u4CqMlyMa003qCnn3VB").then(t=>{this.stripe=t;let e=t?.elements();e&&(this.cardNumber=e.create("cardNumber"),this.cardNumber.mount(this.cardNumberElement?.nativeElement),this.cardNumber.on("change",r=>{this.cardNumberComplete=r.complete,r.error?this.cardErrors=r.error.message:this.cardErrors=null}),this.cardExpiry=e.create("cardExpiry"),this.cardExpiry.mount(this.cardExpiryElement?.nativeElement),this.cardExpiry.on("change",r=>{this.cardExpiryComplete=r.complete,r.error?this.cardErrors=r.error.message:this.cardErrors=null}),this.cardCvc=e.create("cardCvc"),this.cardCvc.mount(this.cardCvcElement?.nativeElement),this.cardCvc.on("change",r=>{this.cardCvcComplete=r.complete,r.error?this.cardErrors=r.error.message:this.cardErrors=null}))})}get paymentFormComplete(){return this.checkoutForm?.get("paymentForm")?.valid&&this.cardNumberComplete&&this.cardExpiryComplete&&this.cardCvcComplete}submitOrder(){return R(this,null,function*(){this.loading=!0;let t=this.basketService.getCurrentBasketValue();if(!t)throw new Error("cannot get basket");try{let e=yield this.createOrder(t),r=yield this.confirmPaymentWithStripe(t);if(r.paymentIntent){this.basketService.deleteBasket(t);let o={state:e};this.router.navigate(["checkout/success"],o)}else this.toastr.error(r.error.message)}catch(e){console.log(e),this.toastr.error(e.message)}finally{this.loading=!1}})}confirmPaymentWithStripe(t){return R(this,null,function*(){if(!t)throw new Error("Basket is null");let e=this.stripe?.confirmCardPayment(t.clientSecret,{payment_method:{card:this.cardNumber,billing_details:{name:this.checkoutForm?.get("paymentForm")?.get("nameOnCard")?.value}}});if(!e)throw new Error("Problem attempting payment with stripe");return e})}createOrder(t){return R(this,null,function*(){if(!t)throw new Error("Basket is null");let e=this.getOrderToCreate(t);return this.checkoutService.createOrder(e).toPromise()})}getOrderToCreate(t){let e=this.checkoutForm?.get("deliveryForm")?.get("deliveryMethod")?.value,r=this.checkoutForm?.get("addressForm")?.value;if(!e||!r)throw new Error("Problem with basket");return{basketId:t.id,deliveryMethodId:e,shipToAddress:r}}static \u0275fac=function(e){return new(e||i)(p(S),p(P),p(M),p($))};static \u0275cmp=f({type:i,selectors:[["app-checkout-payment"]],viewQuery:function(e,r){if(e&1&&(A(ht,5),A(kt,5),A(Ct,5)),e&2){let o;V(o=L())&&(r.cardNumberElement=o.first),V(o=L())&&(r.cardExpiryElement=o.first),V(o=L())&&(r.cardCvcElement=o.first)}},inputs:{checkoutForm:"checkoutForm"},decls:9,vars:3,consts:[["cardNumber",""],["cardExpiry",""],["cardCvc",""],["class","mt-4",3,"formGroup",4,"ngIf"],[1,"d-flex","justify-content-between","flex-row","mb-5"],["cdkStepperPrevious","",1,"btn","btn-outline-primary"],[1,"fa","fa-angle-left"],[1,"btn","btn-primary",3,"click","disabled"],[1,"fa","fa-angle-right"],["class","fa fa-spinner fa-spin",4,"ngIf"],[1,"mt-4",3,"formGroup"],[1,"row"],["formGroupName","paymentForm",1,"form-group","col-12"],["formControlName","nameOnCard",3,"label"],[1,"row","mb-3"],[1,"col-6"],[1,"form-floating"],[1,"form-control"],[1,"text-danger"],[1,"col-3"],[1,"fa","fa-spinner","fa-spin"]],template:function(e,r){e&1&&(h(0,yt,25,3,"div",3),n(1,"div",4)(2,"button",5),m(3,"i",6),l(4," Back to review "),a(),n(5,"button",7),k("click",function(){return r.submitOrder()}),l(6," Submit order "),m(7,"i",8),h(8,bt,1,0,"i",9),a()()),e&2&&(s("ngIf",r.checkoutForm),c(5),s("disabled",r.loading||!r.paymentFormComplete),c(3),s("ngIf",r.loading))},dependencies:[y,X,I,_,H,w,z,N]})};var ce=class i{constructor(t,e,r){this.fb=t;this.accountService=e;this.basketService=r}basketTotals$;checkoutForm;ngOnInit(){this.createCheckoutForm(),this.getAddressFormValues(),this.getDeliveryMethodValue(),this.basketTotals$=this.basketService.basketTotal$}createCheckoutForm(){this.checkoutForm=this.fb.group({addressForm:this.fb.group({firstName:[null,b.required],lastName:[null,b.required],street:[null,b.required],city:[null,b.required],zipcode:[null,b.required]}),deliveryForm:this.fb.group({deliveryMethod:[null,b.required]}),paymentForm:this.fb.group({nameOnCard:[null,b.required]})})}getAddressFormValues(){this.accountService.getUserAddress().subscribe(t=>{t&&this.checkoutForm.get("addressForm")?.patchValue(t)},t=>{console.log(t)})}getDeliveryMethodValue(){let t=this.basketService.getCurrentBasketValue();t.deliveryMethodId!==null&&this.checkoutForm.get("deliveryForm")?.get("deliveryMethod")?.patchValue(t.deliveryMethodId?.toString())}static \u0275fac=function(e){return new(e||i)(p(Oe),p(J),p(S))};static \u0275cmp=f({type:i,selectors:[["app-checkout"]],decls:15,vars:11,consts:[["appStepper",""],[1,"container","mt-5"],[1,"row"],[1,"col-12","col-lg-8","mb-4","mb-lg-0"],[3,"linearModeSelected"],[3,"label","completed"],[3,"checkoutForm"],[3,"label"],[3,"appStepper"],[1,"col-12","col-lg-4"]],template:function(e,r){if(e&1&&(n(0,"div",1)(1,"div",2)(2,"div",3)(3,"app-stepper",4,0)(5,"cdk-step",5),m(6,"app-checkout-address",6),a(),n(7,"cdk-step",5),m(8,"app-checkout-delivery",6),a(),n(9,"cdk-step",7),m(10,"app-checkout-review",8),a(),n(11,"cdk-step",7),m(12,"app-checkout-payment",6),a()()(),n(13,"div",9),m(14,"app-order-totals"),a()()()),e&2){let o,d,u=ge(4);c(3),s("linearModeSelected",!0),c(2),s("label","Address")("completed",(o=r.checkoutForm.get("addressForm"))==null?null:o.valid),c(),s("checkoutForm",r.checkoutForm),c(),s("label","Delivery")("completed",(d=r.checkoutForm.get("deliveryForm"))==null?null:d.valid),c(),s("checkoutForm",r.checkoutForm),c(),s("label","Review"),c(),s("appStepper",u),c(),s("label","Payment"),c(),s("checkoutForm",r.checkoutForm)}},dependencies:[je,De,Z,ee,re,ie,ae]})};var gt=i=>["/orders/",i];function Ft(i,t){if(i&1&&(n(0,"button",5),l(1," View your order "),a()),i&2){let e=v();s("routerLink",Ie(1,gt,e.order.id))}}function Et(i,t){i&1&&(n(0,"button",6),l(1," View your orders "),a())}var se=class i{constructor(t){this.router=t;let e=this.router.getCurrentNavigation(),r=e&&e.extras&&e.extras.state;r&&(this.order=r)}order;static \u0275fac=function(e){return new(e||i)(p($))};static \u0275cmp=f({type:i,selectors:[["app-checkout-success"]],decls:9,vars:2,consts:[[1,"container","mt-5"],[1,"fa","fa-check-circle","fa-5x",2,"color","green"],[1,"mb-4"],["class","btn btn-outline-success",3,"routerLink",4,"ngIf"],["routerLink","/orders","class","btn btn-outline-success",4,"ngIf"],[1,"btn","btn-outline-success",3,"routerLink"],["routerLink","/orders",1,"btn","btn-outline-success"]],template:function(e,r){e&1&&(n(0,"div",0)(1,"div"),m(2,"i",1),a(),n(3,"h2"),l(4,"Thank you. Your order is confirmed!"),a(),n(5,"p",2),l(6,"Your order will be shipped soon!"),a(),h(7,Ft,2,3,"button",3)(8,Et,2,0,"button",4),a()),e&2&&(c(7),s("ngIf",r.order),c(),s("ngIf",!r.order))},dependencies:[y,W]})};var xt=[{path:"",component:ce},{path:"success",component:se}],me=class i{static \u0275fac=function(e){return new(e||i)};static \u0275mod=B({type:i});static \u0275inj=j({imports:[Q,pe.forChild(xt),pe]})};var Xe=class i{static \u0275fac=function(e){return new(e||i)};static \u0275mod=B({type:i});static \u0275inj=j({imports:[Q,me,Re]})};export{Xe as CheckoutModule};
