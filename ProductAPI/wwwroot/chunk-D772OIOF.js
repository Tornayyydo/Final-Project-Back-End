import{c as b}from"./chunk-SZOBYU5N.js";import{B as I,E as h,g as u,m as p,ub as B}from"./chunk-BFXX2XRG.js";var i=[];for(let s=0;s<256;++s)i.push((s+256).toString(16).slice(1));function g(s,t=0){return(i[s[t+0]]+i[s[t+1]]+i[s[t+2]]+i[s[t+3]]+"-"+i[s[t+4]]+i[s[t+5]]+"-"+i[s[t+6]]+i[s[t+7]]+"-"+i[s[t+8]]+i[s[t+9]]+"-"+i[s[t+10]]+i[s[t+11]]+i[s[t+12]]+i[s[t+13]]+i[s[t+14]]+i[s[t+15]]).toLowerCase()}var l,x=new Uint8Array(16);function m(){if(!l){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");l=crypto.getRandomValues.bind(crypto)}return l(x)}var y=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),d={randomUUID:y};function v(s,t,e){if(d.randomUUID&&!t&&!s)return d.randomUUID();s=s||{};let r=s.random??s.rng?.()??m();if(r.length<16)throw new Error("Random bytes length must be >= 16");if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,t){if(e=e||0,e<0||e+16>t.length)throw new RangeError(`UUID byte range ${e}:${e+15} is out of buffer bounds`);for(let a=0;a<16;++a)t[e+a]=r[a];return t}return g(r)}var c=v;var n=class{id=c();items=[]};var f=class s{constructor(t){this.http=t}baseUrl=b.apiUrl;basketSource=new u(null);basket$=this.basketSource.asObservable();basketTotalSource=new u(null);basketTotal$=this.basketTotalSource.asObservable();shipping=0;createPaymentIntent(){return this.http.post(this.baseUrl+"payments/"+this.getCurrentBasketValue().id,{}).pipe(p(t=>{this.basketSource.next(t),console.log(this.getCurrentBasketValue())}))}setShippingPrice(t){this.shipping=t.price;let e=this.getCurrentBasketValue();e.deliveryMethodId=t.id,e.shippingPrice=t.price,this.calculateTotals(),this.setBasket(e)}getBasket(t){return this.http.get(this.baseUrl+"basket?id="+t).pipe(p(e=>{this.basketSource.next(e),this.shipping=e.shippingPrice??0,this.calculateTotals()}))}setBasket(t){return this.http.post(this.baseUrl+"basket",t).subscribe(e=>{this.basketSource.next(e),this.calculateTotals()},e=>{console.log(e)})}getCurrentBasketValue(){return this.basketSource.value}addItemToBasket(t,e=1){let r=this.mapProductItemToBasketItem(t,e),a=this.getCurrentBasketValue()??this.createBasket();a.items=this.addOrUpdateItem(a.items,r,e),this.setBasket(a)}incrementItemQuantity(t){let e=this.getCurrentBasketValue(),r=e.items.findIndex(a=>a.id===t.id);e.items[r].quantity++,this.setBasket(e)}decrementItemQuantity(t){let e=this.getCurrentBasketValue(),r=e.items.findIndex(a=>a.id===t.id);e.items[r].quantity>1?(e.items[r].quantity--,this.setBasket(e)):this.removeItemFromBasket(t)}removeItemFromBasket(t){let e=this.getCurrentBasketValue();e.items.some(r=>r.id===t.id)&&(e.items=e.items.filter(r=>r.id!==t.id),e.items.length>0?this.setBasket(e):this.deleteBasket(e))}deleteBasket(t){return this.http.delete(this.baseUrl+"basket?id="+t.id).subscribe(()=>{this.basketSource.next(null),this.basketTotalSource.next(null),localStorage.removeItem("basket_id")},e=>{console.log(e)})}calculateTotals(){let t=this.getCurrentBasketValue(),e=this.shipping,r=t.items.reduce((o,k)=>k.price*k.quantity+o,0),a=r+e;this.basketTotalSource.next({shipping:e,total:a,subtotal:r})}addOrUpdateItem(t,e,r){let a=t.findIndex(o=>o.id===e.id);return a==-1?(e.quantity=r,t.push(e)):t[a].quantity+=r,t}createBasket(){let t=new n;return localStorage.setItem("basket_id",t.id),t}mapProductItemToBasketItem(t,e){return{id:t.id,productName:t.name,price:t.price,pictureUrl:t.pictureUrl,quantity:e,brand:t.productBrand,type:t.productType}}static \u0275fac=function(e){return new(e||s)(h(B))};static \u0275prov=I({token:s,factory:s.\u0275fac,providedIn:"root"})};export{f as a};
